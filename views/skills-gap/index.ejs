<% const pageTitle = 'Skills Gap Analysis'; %>
<%- include('../partials/layout-start', { title: pageTitle }) %>

<div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-2xl font-bold text-gray-800 mb-2">üìà Skills Gap Analysis</h1>
        <p class="text-gray-600">Identifique gaps de compet√™ncias e receba um roadmap personalizado para sua evolu√ß√£o</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Formul√°rio -->
        <div class="lg:col-span-2 space-y-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Defina seu Objetivo</h3>
                
                <div class="space-y-4">
                    <div>
                        <label for="cargoAlvo" class="block text-sm font-medium text-gray-700 mb-1">Cargo/Posi√ß√£o Alvo *</label>
                        <input type="text" id="cargoAlvo" placeholder="Ex: Tech Lead, Staff Engineer, CTO" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="nivel" class="block text-sm font-medium text-gray-700 mb-1">N√≠vel Desejado</label>
                        <select id="nivel" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                            <option value="">Selecione...</option>
                            <option value="junior">Junior</option>
                            <option value="pleno">Pleno</option>
                            <option value="senior">S√™nior</option>
                            <option value="tech_lead">Tech Lead</option>
                            <option value="staff">Staff / Principal</option>
                            <option value="manager">Manager</option>
                            <option value="director">Director / VP</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="descricaoAlvo" class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o da Vaga (Opcional)</label>
                        <textarea id="descricaoAlvo" rows="6" placeholder="Cole uma descri√ß√£o de vaga para an√°lise mais precisa..."
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"></textarea>
                        <p class="text-xs text-gray-500 mt-1">Quanto mais detalhes, melhor ser√° a an√°lise</p>
                    </div>
                </div>
                
                <button onclick="analyzeGaps()" class="w-full mt-6 px-6 py-4 bg-orange-600 text-white font-semibold rounded-lg hover:bg-orange-700 transition flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Analisar Gaps e Gerar Roadmap
                </button>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <div class="bg-orange-50 border border-orange-200 rounded-xl p-6">
                <h4 class="font-semibold text-orange-800 mb-3">üéØ O que voc√™ receber√°</h4>
                <ul class="text-sm text-orange-700 space-y-2">
                    <li>‚úì Score de compatibilidade atual</li>
                    <li>‚úì Lista de gaps identificados</li>
                    <li>‚úì Roadmap em 3 fases</li>
                    <li>‚úì Cursos e certifica√ß√µes recomendados</li>
                    <li>‚úì Projetos pr√°ticos sugeridos</li>
                    <li>‚úì Pr√≥ximos passos acion√°veis</li>
                </ul>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h4 class="font-semibold text-gray-800 mb-3">Seu Perfil Atual</h4>
                <% if (perfil) { %>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-500">Experi√™ncias:</span>
                        <span class="font-medium text-gray-800"><%= experiencias?.length || 0 %></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">Certifica√ß√µes:</span>
                        <span class="font-medium text-gray-800"><%= cursos?.length || 0 %></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">Idiomas:</span>
                        <span class="font-medium text-gray-800"><%= idiomas?.length || 0 %></span>
                    </div>
                </div>
                <% } else { %>
                <p class="text-sm text-yellow-600">Complete seu perfil para an√°lise mais precisa</p>
                <% } %>
            </div>
        </div>
    </div>

    <!-- Resultado -->
    <div id="resultado" class="mt-8 hidden space-y-6">
        <!-- Score Card -->
        <div class="bg-gradient-to-r from-orange-500 to-amber-500 rounded-xl p-8 text-white">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="text-center">
                    <p class="text-orange-100 text-sm uppercase tracking-wide">Score de Compatibilidade</p>
                    <p id="scoreValue" class="text-5xl font-bold mt-2">--</p>
                </div>
                <div class="text-center">
                    <p class="text-orange-100 text-sm uppercase tracking-wide">N√≠vel Atual</p>
                    <p id="nivelAtual" class="text-2xl font-semibold mt-2">--</p>
                </div>
                <div class="text-center">
                    <p class="text-orange-100 text-sm uppercase tracking-wide">N√≠vel Alvo</p>
                    <p id="nivelAlvo" class="text-2xl font-semibold mt-2">--</p>
                </div>
                <div class="text-center">
                    <p class="text-orange-100 text-sm uppercase tracking-wide">Tempo Estimado</p>
                    <p id="tempoEstimado" class="text-2xl font-semibold mt-2">--</p>
                </div>
            </div>
            <p id="resumoAnalise" class="mt-6 text-orange-100 text-center"></p>
        </div>

        <!-- Gaps Identificados -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">üîç Gaps Identificados</h3>
            </div>
            <div id="gapsContainer" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Renderizado via JS -->
            </div>
        </div>

        <!-- Roadmap -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">üó∫Ô∏è Roadmap de Desenvolvimento</h3>
            </div>
            <div id="roadmapContainer" class="p-6">
                <!-- Renderizado via JS -->
            </div>
        </div>

        <!-- Certifica√ß√µes e Recursos -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800">üèÜ Certifica√ß√µes Recomendadas</h3>
                </div>
                <div id="certificacoesContainer" class="p-6 space-y-3">
                    <!-- Renderizado via JS -->
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800">üíª Projetos Sugeridos</h3>
                </div>
                <div id="projetosContainer" class="p-6 space-y-3">
                    <!-- Renderizado via JS -->
                </div>
            </div>
        </div>

        <!-- Pr√≥ximos Passos -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">üöÄ Pr√≥ximos Passos</h3>
            </div>
            <div id="proximosPassosContainer" class="p-6">
                <!-- Renderizado via JS -->
            </div>
        </div>
    </div>
</div>

<!-- Loading -->
<div id="loading" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-xl p-8 text-center">
        <div class="animate-spin w-12 h-12 border-4 border-orange-200 border-t-orange-600 rounded-full mx-auto mb-4"></div>
        <p class="text-gray-800 font-medium">Analisando seu perfil...</p>
        <p class="text-sm text-gray-500 mt-1">Gerando roadmap personalizado</p>
    </div>
</div>

<script>
async function analyzeGaps() {
    const titulo = document.getElementById('cargoAlvo').value.trim();
    const nivel = document.getElementById('nivel').value;
    const descricao = document.getElementById('descricaoAlvo').value.trim();
    
    if (!titulo) {
        alert('Informe o cargo/posi√ß√£o alvo');
        return;
    }
    
    showLoading();
    
    try {
        const response = await fetch('/api/skills-gap/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ titulo, nivel, descricao })
        });
        
        const data = await response.json();
        
        if (data.success) {
            renderResults(data.analysis);
            document.getElementById('resultado').classList.remove('hidden');
            document.getElementById('resultado').scrollIntoView({ behavior: 'smooth' });
        } else {
            alert('Erro: ' + data.error);
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao analisar. Tente novamente.');
    } finally {
        hideLoading();
    }
}

function renderResults(analysis) {
    // Score e Info Geral
    const geral = analysis.analise_geral;
    document.getElementById('scoreValue').textContent = geral.score_compatibilidade;
    document.getElementById('nivelAtual').textContent = geral.nivel_atual;
    document.getElementById('nivelAlvo').textContent = geral.nivel_alvo;
    document.getElementById('tempoEstimado').textContent = geral.tempo_estimado_transicao;
    document.getElementById('resumoAnalise').textContent = geral.resumo;
    
    // Gaps
    const gapsContainer = document.getElementById('gapsContainer');
    const importanciaColors = {
        'Cr√≠tica': 'bg-red-100 border-red-300 text-red-800',
        'Alta': 'bg-orange-100 border-orange-300 text-orange-800',
        'M√©dia': 'bg-yellow-100 border-yellow-300 text-yellow-800',
        'Baixa': 'bg-gray-100 border-gray-300 text-gray-800'
    };
    
    gapsContainer.innerHTML = (analysis.gaps_identificados || []).map(gap => `
        <div class="p-4 rounded-lg border ${importanciaColors[gap.importancia] || 'bg-gray-50'}">
            <div class="flex items-start justify-between">
                <div>
                    <span class="text-xs uppercase tracking-wide opacity-70">${gap.categoria}</span>
                    <p class="font-medium mt-1">${gap.habilidade}</p>
                    <p class="text-sm mt-1 opacity-80">${gap.descricao}</p>
                </div>
                <span class="text-xs px-2 py-1 rounded-full bg-white bg-opacity-50">${gap.tempo_para_desenvolver}</span>
            </div>
        </div>
    `).join('');
    
    // Roadmap
    const roadmapContainer = document.getElementById('roadmapContainer');
    const roadmap = analysis.roadmap || {};
    
    roadmapContainer.innerHTML = Object.entries(roadmap).map(([key, fase], index) => `
        <div class="mb-8 last:mb-0">
            <div class="flex items-center gap-4 mb-4">
                <div class="w-10 h-10 rounded-full bg-orange-${(index + 1) * 100 + 400} flex items-center justify-center text-white font-bold">${index + 1}</div>
                <div>
                    <h4 class="font-semibold text-gray-800">${fase.titulo}</h4>
                    <p class="text-sm text-gray-500">${fase.duracao}</p>
                </div>
            </div>
            <div class="ml-14 pl-4 border-l-2 border-orange-200">
                <div class="mb-4">
                    <p class="text-sm font-medium text-gray-700 mb-2">Objetivos:</p>
                    <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                        ${(fase.objetivos || []).map(obj => `<li>${obj}</li>`).join('')}
                    </ul>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-700 mb-2">Recursos:</p>
                    <div class="space-y-2">
                        ${(fase.recursos || []).map(rec => `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div>
                                    <span class="text-xs text-gray-500">${rec.tipo}</span>
                                    <p class="text-sm font-medium text-gray-800">${rec.nome}</p>
                                </div>
                                <span class="text-xs text-gray-500">${rec.tempo}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    // Certifica√ß√µes
    const certContainer = document.getElementById('certificacoesContainer');
    certContainer.innerHTML = (analysis.certificacoes_recomendadas || []).map(cert => `
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
            <div>
                <p class="font-medium text-gray-800">${cert.nome}</p>
                <p class="text-sm text-gray-500">${cert.emissor}</p>
            </div>
            <div class="text-right">
                <span class="text-xs px-2 py-1 rounded-full ${cert.prioridade === 'Alta' ? 'bg-red-100 text-red-700' : cert.prioridade === 'M√©dia' ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-700'}">${cert.prioridade}</span>
                ${cert.custo_estimado ? `<p class="text-xs text-gray-500 mt-1">${cert.custo_estimado}</p>` : ''}
            </div>
        </div>
    `).join('');
    
    // Projetos
    const projContainer = document.getElementById('projetosContainer');
    projContainer.innerHTML = (analysis.projetos_sugeridos || []).map(proj => `
        <div class="p-4 bg-gray-50 rounded-lg">
            <div class="flex items-center gap-2 mb-2">
                <span class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded">${proj.tipo}</span>
            </div>
            <p class="text-sm text-gray-800">${proj.descricao}</p>
            <div class="flex flex-wrap gap-1 mt-2">
                ${(proj.habilidades_desenvolvidas || []).map(skill => `<span class="text-xs px-2 py-1 bg-gray-200 text-gray-700 rounded">${skill}</span>`).join('')}
            </div>
        </div>
    `).join('');
    
    // Pr√≥ximos Passos
    const passosContainer = document.getElementById('proximosPassosContainer');
    const prazoColors = {
        'Essa semana': 'bg-red-500',
        'Esse m√™s': 'bg-orange-500',
        '3 meses': 'bg-blue-500'
    };
    
    passosContainer.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            ${(analysis.proximos_passos || []).map(passo => `
                <div class="p-4 rounded-lg border border-gray-200">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="w-3 h-3 rounded-full ${prazoColors[passo.prazo] || 'bg-gray-500'}"></span>
                        <span class="text-sm font-medium text-gray-600">${passo.prazo}</span>
                    </div>
                    <p class="text-gray-800">${passo.acao}</p>
                </div>
            `).join('')}
        </div>
    `;
}

function showLoading() {
    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('loading').classList.add('flex');
}

function hideLoading() {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('loading').classList.remove('flex');
}
</script>

<%- include('../partials/layout-end') %>
